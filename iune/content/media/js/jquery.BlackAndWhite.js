/**
 *
 * Version: 0.2.7
 * Author:  Gianluca Guarini
 * Contact: gianluca.guarini@gmail.com
 * Website: http://www.gianlucaguarini.com/
 * Twitter: @gianlucaguarini
 *
 * Copyright (c) 2013 Gianluca Guarini
 */
!function(a){a.fn.extend({BlackAndWhite:function(b){"use strict";var c=this,d={hoverEffect:!0,webworkerPath:!1,responsive:!0,invertHoverEffect:!1,speed:500,onImageReady:null};b=a.extend(d,b);var e=b.hoverEffect,f=b.webworkerPath,g=b.invertHoverEffect,h=b.responsive,i=a.isPlainObject(b.speed)?b.speed.fadeIn:b.speed,j=a.isPlainObject(b.speed)?b.speed.fadeOut:b.speed,k=document.all&&!window.opera&&window.XMLHttpRequest?!0:!1,l=" -webkit- -moz- -o- -ms- ".split(" "),m={},n=function(a){if(m[a]||""===m[a])return m[a]+a;var b=document.createElement("div"),c=["","Moz","Webkit","O","ms","Khtml"];for(var d in c)if("undefined"!=typeof b.style[c[d]+a])return m[a]=c[d],c[d]+a;return a.toLowerCase()},o=function(){var a=document.createElement("div");return a.style.cssText=l.join("filter:blur(2px); "),!!a.style.length&&(void 0===document.documentMode||document.documentMode>9)}(),p=!!document.createElement("canvas").getContext,q=a(window),r=function(){return"undefined"!=typeof Worker?!0:!1}(),t=(n("Filter"),[]),u=r&&f?new Worker(f+"BnWWorker.js"):!1,v=function(b){a(b.currentTarget).find(".BWfade").stop(!0,!0)[g?"fadeOut":"fadeIn"](j)},w=function(b){a(b.currentTarget).find(".BWfade").stop(!0,!0)[g?"fadeIn":"fadeOut"](i)},x=function(a){"function"==typeof b.onImageReady&&b.onImageReady(a)},y=function(){t.length&&(u.postMessage(t[0].imageData),u.onmessage=function(a){t[0].ctx.putImageData(a.data,0,0),x(t[0].img),t.splice(0,1),y()})},z=function(a,b,c,d){var h,e=b.getContext("2d"),g=0;e.drawImage(a,0,0,c,d);var i=e.getImageData(0,0,c,d),j=i.data,k=j.length;if(u)t.push({imageData:i,ctx:e,img:a});else{for(;k>g;g+=4)h=.3*j[g]+.59*j[g+1]+.11*j[g+2],j[g]=j[g+1]=j[g+2]=h;e.putImageData(i,0,0),x(a)}},A=function(b,c){var d=b[0],e=d.src,f=b.width(),h=b.height(),i={position:"absolute",top:0,left:0,display:g?"none":"block"};if(p&&!o){var j=d.width,k=d.height;a('<canvas class="BWfade" width="'+j+'" height="'+k+'"></canvas>').prependTo(c);var l=c.find("canvas");l.css(i),z(d,l[0],j,k)}else i[n("Filter")]="grayscale(100%)",a("<img src="+e+' width="'+f+'" height="'+h+'" class="BWFilter BWfade" /> ').prependTo(c),a(".BWFilter").css(a.extend(i,{filter:"progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)"})),x(d)};return this.init=function(){c.each(function(b,c){var d=a(c),e=d.find("img");e.width()?A(e,d):e.on("load",function(){A(e,d)})}),u&&y(),e&&(c.on("mouseleave",v),c.on("mouseenter",w)),h&&q.on("resize orientationchange",c.resizeImages)},this.resizeImages=function(){c.each(function(b,c){var d=a(c).find("img:not(.BWFilter)"),e=k?a(d).prop("width"):a(d).width(),f=k?a(d).prop("height"):a(d).height();a(this).find(".BWFilter, canvas").css({width:e,height:f})})},this.init(b)}})}(jQuery);